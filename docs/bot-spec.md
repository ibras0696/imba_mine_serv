# Техническое задание: Telegram‑бот для управления сервером

## 1. Цель

Создать Telegram‑бота на **Python + aiogram 3.x**, который позволит администраторам удалённо управлять Minecraft-сервером и получать уведомления о его состоянии. Бот не заменяет Makefile/SSH, а упрощает типовые операции: запуск/остановка, просмотр логов, выдача опки, обновление `.env`, контроль модов.

## 2. Пользовательские сценарии

1. **Авторизация** — бот отвечает только списку Telegram ID, перечисленных в `.env.bot` (`TELEGRAM_ADMINS`). Остальным пишет, что доступ запрещён.  
2. **Запуск/остановка** — команды `/up`, `/down`, `/restart` вызывают `make` в директории `/root/imba_mine_serv`. Бот возвращает exit-code и выдержку из логов.  
3. **Статус сервера** — `/status` показывает: работает ли контейнер (`docker compose ps`), сколько игроков на сервере (через `mc-monitor status` или `rcon-cli list`), текущий TPS и RAM.  
4. **Логи** — `/logs 50` присылает последние N строк `docker compose logs`. Для длинных логов бот прикрепляет txt-файл.  
5. **Управление опкой** — `/op ibrass`, `/deop player` используют `docker exec forge-server rcon-cli`. Бот валидирует никнейм и сообщает об успехе.  
6. **Работа с `.env`** — `/env get KEY` выводит значение, `/env set KEY VALUE` редактирует файл (с бэкапом). После применения бот предлагает `/restart`, но не делает его автоматически.  
7. **Моды** — `/mods server` и `/mods client` перечисляют версии из `docs/modpack.md` + реальные `.jar` в каталоге. `/mods upload` принимает архив/файл, сохраняет в `ts_mods/inbox`, а админ применяет позже.  
8. **Уведомления** — подписка `/subscribe crashes` и `/subscribe joins`. Бот следит за `logs/latest.log` (tail -F) и присылает события: вход/выход игроков, ошибки Forge, нехватка модов.  
9. **Бэкапы** — `/backup now` запускает скрипт создания архива мира (`make backup`). По завершении бот шлёт ссылку на архив или подтверждение.  
10. **Git/деплой** (расширенный сценарий) — `/git pull`, `/deploy` для обновления репозитория на VPS и рестарта сервера.

## 3. Архитектура

```
bot/
 ├── main.py              # точка входа aiogram
 ├── config.py            # чтение .env.bot
 ├── handlers/            # модули commands/logs/env/mods/ops/status
 ├── services/
 │    ├── shell.py        # запуск make/docker/ssh команд (async subprocess)
 │    ├── rcon.py         # обёртка над rcon-cli
 │    ├── env_file.py     # чтение/запись .env с бэкапами
 │    ├── modpack.py      # парсинг docs/modpack.md
 │    └── notifier.py     # tail логов, отправка алертов
 ├── data/
 │    ├── bot.log
 │    └── state.json      # текущие подписки на уведомления
 └── README.md            # инструкция по запуску бота
```

- **Деплой**: бот работает на том же VPS, что и сервер, в отдельном systemd-юните (`/etc/systemd/system/imba-bot.service`).  
- **Доступ к серверу**: команды выполняются локально, т.к. бот живёт на той же машине. На стадии теста можно запускать бота на ПК и подключаться к VPS через SSH (используем `asyncssh` или `paramiko`).  
- **Конфигурация**: файл `env/.env.bot` с переменными `BOT_TOKEN`, `TELEGRAM_ADMINS`, `WORKDIR=/root/imba_mine_serv`, `ENV_FILE=env/production.env`, `RCON_PASSWORD`, `RCON_PORT=25575`.

## 4. Безопасность

- Бот принимает команды только от whitelisted ID.  
- Каждое действие логируется с указанием пользователя, команды и результата (`bot/data/bot.log`).  
- Для операций, которые меняют файлы (`/env set`, `/mods upload`), бот делает резервную копию (`.bak` + отметка во внутреннем state). В случае сбоя можно откатить `/env undo`.  
- Ограничение скорости: не более X команд в минуту на пользователя (anti-spam).  
- Команда `/shell` (сырые команды) закрыта и выключена, пока админ явно не откроет через конфиг.  
- Токен Telegram хранится только в `.env.bot`, файл добавлен в `.gitignore`.  
- В `docker-compose` для бота лучше настроить отдельный пользователь (не root) или запускать через virtualenv/systemd с ограниченными правами.

## 5. Требования к реализации

1. **Python 3.11+**, aiogram 3.x, `python-dotenv`, `aiofiles`, `asyncio`.  
2. Обособленный виртуальное окружение (`python -m venv .venv && source .venv/bin/activate`).  
3. Makefile‑таргеты для бота:  
   - `make bot-install` — установка зависимостей (`pip install -r bot/requirements.txt`).  
   - `make bot-run` — запуск dev-режима (`python -m bot.main`).  
   - `make bot-service` — генерация systemd-юнита.  
4. Покрыть критические части юнит-тестами (например, парсер `.env`, обработчик `/env set`).  
5. Описать процесс деплоя в `docs/bot-spec.md` + `docs/deploy-linux.md` (добавить раздел «Бот»).  
6. В логах бота не должно быть токена, пароля rcon и других секретов.  
7. Исключения должны красиво обрабатываться и возвращать пользователю понятное сообщение.

## 6. Бэклог по спринтам

| Спринт | Задачи |
|--------|--------|
| 1 | Базовые команды `/start`, `/help`, `/status`, оболочка для запуска shell-команд, `.env.bot`. |
| 2 | `/up`, `/down`, `/restart`, `/logs`, `/ps`, уведомления об ошибках (tail log). |
| 3 | `/op`, `/deop`, `/env get/set`, `/mods server/client`. |
| 4 | Загрузка файлов `/mods upload`, `/backup now`, интеграция с `make fetch-mods`. |
| 5 | Подписки на события, кастомные алерты (краши, join/leave), интеграция с Git (`/git pull`). |
| 6 | Тестирование, написание README, упаковка в systemd‑юнит, финальный аудит безопасности. |

## 7. Риски и контроль

- **Некорректные команды в `.env`** — добавляем валидацию (белый список ключей, проверка значений).  
- **Конкурентный доступ** — если другой админ вручную редактирует `.env`, бот должен перечитывать файл перед записью и предупреждать о конфликтах.  
- **Зависание make/docker** — ставим таймауты (например, 120 секунд) и возвращаем ошибку, если команда не завершилась.  
- **Спам уведомлениями** — возможность отключить подписку `/unsubscribe crashes`.  
- **Падение бота** — systemd рестартует процесс. В боте реализуем healthcheck (пинг в лог каждые N минут).  
- **Токен Telegram** — хранится только в `.env.bot`, в коде не хардкодим.

## 8. Готовность к реализации

- Репозиторий уже содержит все скрипты для управления сервером, поэтому бот в основном будет вызывать `make` и `docker`.  
- Для RCON понадобится включить `ENABLE_RCON=TRUE`, задать `RCON_PASSWORD` и прокинуть порт в контейнер. Это изменение нужно зафиксировать в `.env.example` и `compose/docker-compose.yml`.  
- После оценки ТЗ можно приступать к sprint 1: создать заготовку `bot/`, прописать зависимости и добавить минимум `/start`, `/help`, `/status`.

Документ можно использовать как основу для issue на GitHub или план-график в Notion/Jira.
